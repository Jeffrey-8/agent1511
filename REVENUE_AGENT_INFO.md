# Revenue Extractor Agent - Система извлечения категорий выручки

## Описание

Агент для надежного извлечения категории выручки из диалога пользователя с ботом.

## Жесткий словарь категорий

Используются уникальные коды для защиты от ошибок LLM при формулировках:

| Код    | Категория выручки    |
|--------|---------------------|
| 888001 | Менее 1 млн.р.      |
| 888002 | 1-10 млн.р.         |
| 888003 | 10-120 млн.р.       |
| 888004 | 120-800 млн.р.      |
| 888005 | Более 800 млн.р.    |

## Как это работает

1. **Промпт содержит коды**: LLM получает справочник с кодами вместо текстовых категорий
2. **LLM возвращает код**: Вместо текста "10-120 млн.р." возвращает "888003"
3. **Регулярное выражение**: Код извлекается regex-паттерном `888(00[1-5])`
4. **Словарь**: По коду получаем точную категорию из словаря

## Преимущества

- ✅ **Защита от опечаток**: LLM может написать "10-120млн" или "от 10 до 120", но код будет всегда "888003"
- ✅ **Надежность**: Regex находит код даже если LLM добавит лишний текст
- ✅ **Однозначность**: Один код = одна категория, без вариантов
- ✅ **Простота отладки**: Легко увидеть какой код вернула модель

## Пример работы

### Входные данные:
```
Диалог:
Пользователь: Мы IT компания
Бот: Какая примерно выручка?
Пользователь: Около 100 млн в год
```

### Что происходит:

1. **Промпт для LLM**:
   ```
   Справочник категорий выручки:
   - 888001 → "Менее 1 млн.р."
   - 888002 → "1-10 млн.р."
   - 888003 → "10-120 млн.р."  ← подходит для 100 млн
   - 888004 → "120-800 млн.р."
   - 888005 → "Более 800 млн.р."
   
   Верни КОД категории для выручки из диалога
   ```

2. **Ответ LLM**:
   ```json
   {"revenue_code": "888003"}
   ```
   
   Или даже если LLM ошибется в формате:
   ```
   Анализ показывает что выручка 100 млн соответствует коду 888003 (диапазон 10-120 млн)
   ```

3. **Regex находит**: `888003`

4. **Словарь возвращает**: `"10-120 млн.р."`

## Использование

```python
from revenue_extractor_agent import RevenueExtractorAgent

# Создаем агента
agent = RevenueExtractorAgent()

# Анализируем диалог
dialog = "Пользователь: Выручка 100 млн\nБот: Понятно"
category = agent.extract_revenue_category(dialog)

print(category)  # "10-120 млн.р."

# Получить все категории
all_categories = agent.get_all_categories()
# {'888001': 'Менее 1 млн.р.', '888002': '1-10 млн.р.', ...}

# Получить категорию по коду
category = agent.get_category_by_code('888003')
# "10-120 млн.р."
```

## Интеграция с Telegram Bot

Агент автоматически интегрирован в `telegram_bot.py`:

1. После сбора информации о компании запускается `RevenueExtractorAgent`
2. Из полного диалога извлекается категория выручки
3. Результат сохраняется в БД в поле `revenue_category`
4. Пользователю показывается определенная категория

## Логирование

Агент логирует все этапы работы:
- Найденные коды через regex
- Ответы от GigaChat
- Результаты сопоставления с словарем
- Ошибки парсинга

Проверить логи можно через стандартный logging Python.

