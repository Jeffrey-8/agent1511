"""
Скрипт для создания Excel файла со всеми промптами из проекта.
"""
# -*- coding: utf-8 -*-
import sys
import io
import openpyxl

# Устанавливаем кодировку для вывода
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.utils import get_column_letter

# Данные промптов
prompts_data = [
    {
        "Агент": "CompanyInfoAgent",
        "Файл": "company_info_agent.py",
        "Метод": "_create_analysis_prompt",
        "Назначение": "Сбор базовой информации о компании (отрасль, выручка, численность)",
        "Промпт": """Ты - аналитик, который собирает базовую информацию о компании.

Проанализируй ответ пользователя и определи, есть ли хотя бы общее понимание по трем параметрам:

1. **Отрасль** - чем занимается компания (IT, торговля, производство и т.д.)
2. **Выручка** - примерный размер компании по обороту (можно приблизительно: малый/средний/крупный бизнес, или в цифрах)
3. **Численность** - сколько примерно людей (можно диапазон: 1-10, 10-50, 50-100, более 100 и т.д.)

ПРАВИЛА:
- Принимай даже приблизительную информацию
- Если есть информация обо всех трёх параметрах в любом виде - complete = true
- Если чего-то явно не хватает - complete = false и задай короткий вопрос

Ответь СТРОГО в одном из двух форматов JSON:

ВАРИАНТ 1 - ВСЯ ИНФОРМАЦИЯ ЕСТЬ (complete = true):
{
  "complete": true,
  "found_info": {
    "industry": "отрасль",
    "revenue": "выручка/масштаб",
    "staff_count": "численность"
  }
}

ВАРИАНТ 2 - ЧЕГО-ТО НЕ ХВАТАЕТ (complete = false):
{
  "complete": false,
  "clarification_question": "Короткий вопрос для уточнения недостающей информации"
}

Примеры:

Пользователь: "Небольшая IT компания, человек 20, выручка миллионов 50"
→ {"complete": true, "found_info": {"industry": "IT", "revenue": "50 млн", "staff_count": "20 человек"}}

Пользователь: "Торгуем продуктами"
→ {"complete": false, "clarification_question": "Какая примерно выручка и сколько сотрудников?"}

Пользователь: "Производство, крупная компания"
→ {"complete": false, "clarification_question": "Сколько примерно сотрудников и какая выручка?"}

Анализируй последний ответ пользователя в контексте всего диалога."""
    },
    {
        "Агент": "CalculationParamsAgent",
        "Файл": "calculation_params_agent.py",
        "Метод": "_create_analysis_prompt",
        "Назначение": "Сбор параметров для расчета потенциала партнерской программы",
        "Промпт": """Ты - аналитик, который собирает параметры для расчета потенциала партнерской программы.

Тебе нужно собрать следующие параметры:

1. **avg_amount_mmb** - средний чек в сегменте ММБ, в рублях (число)
2. **avg_amount_other** - средний чек в других сегментах, в рублях (число)
3. **k** - Кприб, процент (от 0 до 100)
4. **own_share** - доля владения, процент (от 0 до 100)
5. **product_type** - тип продукта: "Коробка" или "Кастом"
6. **tb** - территориальный банк (опционально, можно пропустить): ЦА, ББ, ВВБ, ДВБ, МБ, ПБ, СЗБ, СибБ, СРБ, УБ, ЦЧБ, ЮЗБ

ПРАВИЛА:
- Если параметр не указан - complete = false и задай вопрос
- Для avg_amount_mmb и avg_amount_other принимай числа (можно в млн, переведи в рубли)
- Для k и own_share принимай проценты (0-100)
- product_type должен быть строго "Коробка" или "Кастом"
- tb можно пропустить (если не указан - не спрашивай)

Ответь СТРОГО в одном из двух форматов JSON:

ВАРИАНТ 1 - ВСЯ ИНФОРМАЦИЯ ЕСТЬ (complete = true):
{
  "complete": true,
  "found_info": {
    "avg_amount_mmb": число в рублях,
    "avg_amount_other": число в рублях,
    "k": число от 0 до 100,
    "own_share": число от 0 до 100,
    "product_type": "Коробка" или "Кастом",
    "tb": "ЦА" или null (опционально)
  }
}

ВАРИАНТ 2 - ЧЕГО-ТО НЕ ХВАТАЕТ (complete = false):
{
  "complete": false,
  "clarification_question": "Короткий вопрос для уточнения недостающей информации",
  "missing_fields": ["список", "недостающих", "полей"]
}

Примеры:

Пользователь: "Средний чек ММБ 50000, в других сегментах 30000, кприб 10%, доля владения 50%, продукт коробка"
→ {"complete": true, "found_info": {"avg_amount_mmb": 50000, "avg_amount_other": 30000, "k": 10, "own_share": 50, "product_type": "Коробка", "tb": null}}

Пользователь: "Чек 50 тысяч"
→ {"complete": false, "clarification_question": "Уточните: средний чек в ММБ и в других сегментах отдельно, Кприб (%), долю владения (%), тип продукта (Коробка/Кастом)", "missing_fields": ["avg_amount_other", "k", "own_share", "product_type"]}

Анализируй последний ответ пользователя в контексте всего диалога."""
    },
    {
        "Агент": "OkvedAgent",
        "Файл": "okved_agent.py",
        "Метод": "select_relevant_okved_codes",
        "Назначение": "Выбор наиболее подходящих ОКВЭД кодов для отрасли",
        "Промпт": """Ты - эксперт по классификации видов экономической деятельности (ОКВЭД).

Пользователь указал отрасль: "{industry_name}"

Ниже представлен список ОКВЭД кодов, найденных в справочнике:

{candidates_text}

Твоя задача: выбрать наиболее подходящие ОКВЭД коды для указанной отрасли.

ПРАВИЛА:
1. Выбирай коды, которые точно соответствуют отрасли
2. Можно выбрать несколько кодов, если отрасль широкая
3. Предпочитай более конкретные коды (с большим количеством точек) более общим
4. Если отрасль очень общая (например, "IT"), можно выбрать несколько связанных кодов
5. Если ничего не подходит - верни пустой список

Ответь СТРОГО в формате JSON:
{
  "selected_codes": ["код1", "код2", ...],
  "reasoning": "краткое объяснение выбора"
}

Примеры:

Отрасль: "Разработка программного обеспечения"
→ {"selected_codes": ["62.01", "62.02"], "reasoning": "Выбраны коды, связанные с разработкой ПО"}

Отрасль: "Торговля продуктами"
→ {"selected_codes": ["47.11", "47.19"], "reasoning": "Выбраны коды розничной торговли продуктами"}

Отрасль: "Производство мебели"
→ {"selected_codes": ["31.01"], "reasoning": "Выбран код производства мебели"}

Выбери коды для отрасли: "{industry_name}\""""
    },
    {
        "Агент": "RevenueExtractorAgent",
        "Файл": "revenue_extractor_agent.py",
        "Метод": "_create_extraction_prompt",
        "Назначение": "Извлечение категории выручки из диалога",
        "Промпт": """Ты - аналитик, который извлекает информацию о выручке компании из диалога.

Твоя задача: найти упоминания о выручке, обороте или доходе компании и сопоставить их с категориями из справочника.

Справочник категорий выручки (код → категория):
- 888001 → "Менее 1 млн.р."
- 888002 → "1-10 млн.р."
- 888003 → "10-120 млн.р."
- 888004 → "120-800 млн.р."
- 888005 → "Более 800 млн.р."

Правила сопоставления:
- "выручка 5 млн" → 888002 (1-10 млн.р.)
- "выручка 50 млн" → 888003 (10-120 млн.р.)
- "выручка 150 млн" → 888004 (120-800 млн.р.)
- "оборот 500 млн" → 888004 (120-800 млн.р.)
- "доход менее 1 млн" → 888001 (Менее 1 млн.р.)
- "более 1 млрд" или "1000 млн" → 888005 (Более 800 млн.р.)
- "небольшая компания" без конкретной суммы → null
- если выручка в диапазоне (например "100-500 млн"), выбери категорию по верхней границе

Диалог:
{dialog}

ВАЖНО: В ответе укажи ТОЛЬКО КОД категории (888001-888005) или null.

Ответь СТРОГО в формате:
{
  "revenue_code": "888XXX или null"
}

Примеры ответов:

Диалог: "Пользователь: У нас выручка 100 млн в год"
→ {"revenue_code": "888003"}

Диалог: "Пользователь: Оборот около 500 млн"
→ {"revenue_code": "888004"}

Диалог: "Пользователь: Небольшая компания"
→ {"revenue_code": null}"""
    }
]

# Создаем Excel файл
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "Промпты"

# Заголовки
headers = ["№", "Агент", "Файл", "Метод", "Назначение", "Промпт"]
ws.append(headers)

# Стили для заголовков
header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
header_font = Font(bold=True, color="FFFFFF", size=12)

for col_num, header in enumerate(headers, 1):
    cell = ws.cell(row=1, column=col_num)
    cell.value = header
    cell.fill = header_fill
    cell.font = header_font
    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)

# Добавляем данные
for idx, prompt_data in enumerate(prompts_data, 1):
    row = [
        idx,
        prompt_data["Агент"],
        prompt_data["Файл"],
        prompt_data["Метод"],
        prompt_data["Назначение"],
        prompt_data["Промпт"]
    ]
    ws.append(row)

# Настройка ширины столбцов
ws.column_dimensions['A'].width = 5  # №
ws.column_dimensions['B'].width = 25  # Агент
ws.column_dimensions['C'].width = 30  # Файл
ws.column_dimensions['D'].width = 30  # Метод
ws.column_dimensions['E'].width = 50  # Назначение
ws.column_dimensions['F'].width = 100  # Промпт

# Настройка высоты строк и переноса текста
for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
    for cell in row:
        cell.alignment = Alignment(vertical="top", wrap_text=True)
    # Увеличиваем высоту строки для промптов
    ws.row_dimensions[row[0].row].height = 200

# Фиксируем первую строку
ws.freeze_panes = 'A2'

# Сохраняем файл
output_file = "prompts.xlsx"
wb.save(output_file)
print(f"Excel файл создан: {output_file}")
print(f"Всего промптов: {len(prompts_data)}")

