# potential_agent.py
import json
import logging
import re
from typing import Dict, Any, List, Union

from langchain_core.messages import HumanMessage, AIMessage

from analytics_engine import calculate_potential_full_pipeline
from llm_client import GigaChatLLM

logger = logging.getLogger(__name__)


class PotentialCalculationAgent:
    """
    –ê–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π:
    - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
    - —Å—Ç—Ä–æ–∏—Ç –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é,
    - –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω —Ä–∞—Å—á—ë—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞.
    """

    def __init__(self, llm: GigaChatLLM, data_dir: str):
        self.llm = llm
        self.data_dir = data_dir

    # ==== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ==============================================

    def _extract_answer_block(self, text: str) -> str:
        """
        –í—ã—Ä–µ–∑–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–≥–∞ <ANSWER>...</ANSWER>.
        –ï—Å–ª–∏ —Ç–µ–≥–æ–≤ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç.
        """
        pattern = r"<ANSWER>(.*?)</ANSWER>"
        m = re.search(pattern, text, re.DOTALL | re.IGNORECASE)
        if m:
            return m.group(1).strip()
        return text.strip()

    def _safe_json_loads(self, raw: str):
        """
        –ù–∞–¥—ë–∂–Ω–æ –¥–æ—Å—Ç–∞—ë–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM.

        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å–ª—É—á–∞–∏:
        1) –û—Ç–≤–µ—Ç = —á–∏—Å—Ç—ã–π JSON: { ... }
        2) –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç <REASONING>...</REASONING><ANSWER>{...}</ANSWER>
        3) –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç <ANSWER>{...} –ë–ï–ó –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ </ANSWER>
        4) –û—Ç–≤–µ—Ç - –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —Å –≤–∫—Ä–∞–ø–ª—ë–Ω–Ω—ã–º JSON { ... }.

        –°—Ç—Ä–∞—Ç–µ–≥–∏—è:
        - –µ—Å–ª–∏ –µ—Å—Ç—å <ANSWER>...</ANSWER> ‚Äî –±–µ—Ä—ë–º —Ç–æ, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏.
        - –∏–Ω–∞—á–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å–æ –≤—Å–µ–º —Ç–µ–∫—Å—Ç–æ–º.
        - –¥–∞–ª–µ–µ –∏—â–µ–º –ø–µ—Ä–≤—É—é '{' –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é '}' –∏ –ø—Ä–æ–±—É–µ–º json.loads().
        """
        if not raw:
            return None

        text = str(raw).strip()
        if not text:
            return None

        # 1. –ï—Å–ª–∏ –µ—Å—Ç—å <ANSWER>...</ANSWER> ‚Äî –∑–∞–±–∏—Ä–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        m = re.search(r"<ANSWER>(.*?)</ANSWER>", text, re.DOTALL | re.IGNORECASE)
        if m:
            candidate = m.group(1).strip()
        else:
            # 2. –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–≥–∞ –Ω–µ—Ç (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ) ‚Äî
            #    —Ä–∞–±–æ—Ç–∞–µ–º —Å–æ –≤—Å–µ–º —Ç–µ–∫—Å—Ç–æ–º –∏ –≤—ã—Ä–µ–∑–∞–µ–º { ... }
            start = text.find("{")
            end = text.rfind("}")
            if start == -1 or end == -1 or end <= start:
                logger.warning(f"[safe_json] –Ω–µ –Ω–∞—à—ë–ª JSON-—Å–∫–æ–±–æ–∫ –≤ –æ—Ç–≤–µ—Ç–µ: {text!r}")
                return None
            candidate = text[start : end + 1].strip()

        try:
            data = json.loads(candidate)
            logger.info(f"[safe_json] parsed={data!r}")
            return data
        except Exception as e:
            logger.warning(f"[safe_json] –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: {candidate!r}; err={e}")
            return None


    # ==== 1. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ ==============================

    def is_show_filters_request(self, text: str) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã.
        """
        t = text.lower()
        triggers = [
            "–ø–æ–∫–∞–∂–∏ —Ñ–∏–ª—å—Ç—Ä—ã",
            "–∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã",
            "–∫–∞–∫–∏–µ —Å–µ–π—á–∞—Å —Ñ–∏–ª—å—Ç—Ä—ã",
            "–≤—ã–≤–µ–¥–∏ —Ñ–∏–ª—å—Ç—Ä—ã",
            "—á—Ç–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª–∏",
            "—á—Ç–æ —Å–µ–π—á–∞—Å —Ñ–∏–ª—å—Ç—Ä—É–µ–º",
        ]
        return any(tr in t for tr in triggers)

    def format_filters_for_user(self, state: Dict[str, Any]) -> str:
        """
        –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
        """
        filters = state.get("filters", {}) or {}
        segment_params = state.get("segment_params", {}) or {}
        product_type = state.get("product_type", "–ö–æ—Ä–æ–±–∫–∞")

        industries = filters.get("industries") or "–Ω–µ –∑–∞–¥–∞–Ω—ã (–±–µ—Ä—ë–º –≤—Å–µ –æ—Ç—Ä–∞—Å–ª–∏)"
        revenue = filters.get("revenue") or "–Ω–µ –∑–∞–¥–∞–Ω—ã (–ª—é–±–æ–π —É—Ä–æ–≤–µ–Ω—å –≤—ã—Ä—É—á–∫–∏)"
        staff = filters.get("staff") or "–Ω–µ –∑–∞–¥–∞–Ω (–ª—é–±–æ–π —Ä–∞–∑–º–µ—Ä —à—Ç–∞—Ç–∞)"
        tb = filters.get("tb") or "–Ω–µ –∑–∞–¥–∞–Ω (–≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã)"

        text_lines: List[str] = [
            "üìå –¢–µ–∫—É—â–∏–µ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:",
            f"‚Ä¢ –û—Ç—Ä–∞—Å–ª–∏ (–û–ö–í–≠–î): {industries}",
            f"‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω—ã –≤—ã—Ä—É—á–∫–∏: {revenue}",
            f"‚Ä¢ –†–∞–∑–º–µ—Ä —à—Ç–∞—Ç–∞: {staff}",
            f"‚Ä¢ –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏ (–¢–ë): {tb}",
            f"‚Ä¢ –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞: {product_type}",
            "‚Ä¢ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–¥–æ–ª—è –≤–ª–∞–¥–µ–Ω–∏—è / –ö–ø—Ä–∏–±): "
            f"{json.dumps(segment_params, ensure_ascii=False)}",
            "",
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —á—Ç–æ-—Ç–æ –ø–æ–º–µ–Ω—è—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: "
            "\"—Å–¥–µ–ª–∞–π —Ç–æ–ª—å–∫–æ —Ä–æ–∑–Ω–∏—á–Ω—É—é —Ç–æ—Ä–≥–æ–≤–ª—é –ø–æ –ú–æ—Å–∫–≤–µ\" –∏–ª–∏ "
            "\"–æ–≥—Ä–∞–Ω–∏—á—å –≤—ã—Ä—É—á–∫–æ–π –¥–æ 120 –º–ª–Ω\".",
        ]
        return "\n".join(text_lines)

    # ==== 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–º–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã) ==========================

    def update_filters_from_message(self, state: Dict[str, Any], user_message: str) -> None:
        """
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–º–ø—Ç—ã:
        - –æ—Ç—Ä–∞—Å–ª–∏ (industries)
        - –≤—ã—Ä—É—á–∫–∞ (revenue)
        - —à—Ç–∞—Ç (staff)
        - —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏ (tb)
        - —Ç–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞ (product_type)
        - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞ (segment_params: –¥–æ–ª—è –∏ –ö–ø—Ä–∏–± –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º)

        –û–±–Ω–æ–≤–ª—è–µ—Ç:
        - state["filters"]["industries"/"revenue"/"staff"/"tb"]
        - state["product_type"]
        - state["segment_params"]
        """

        if "filters" not in state or state["filters"] is None:
            state["filters"] = {}
        filters = state["filters"]
        # 1. –û—Ç—Ä–∞—Å–ª–∏ (industries) ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –û–ö–í–≠–î, –æ–±—Ä–µ–∑–∞–µ–º –∫ —Ñ–æ—Ä–º–∞—Ç—É XX.X
        # 1. –û—Ç—Ä–∞—Å–ª–∏ (industries) ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –û–ö–í–≠–î, –æ–±—Ä–µ–∑–∞–µ–º –∫ —Ñ–æ—Ä–º–∞—Ç—É XX.X
        prompt_industries = f"""
        –¢—ã –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–≤–ª–µ–∫–∞–µ—Ç –æ—Ç—Ä–∞—Å–ª–∏ (–û–ö–í–≠–î 2) –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

        –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã:
        1) –í–Ω—É—Ç—Ä–∏ <REASONING> —Ç—ã –º–æ–∂–µ—à—å –¥—É–º–∞—Ç—å –∏ —Ä–∞—Å–ø–∏—Å—ã–≤–∞—Ç—å –ª–æ–≥–∏–∫—É.
        2) –í–Ω—É—Ç—Ä–∏ <ANSWER> —Ç—ã –î–û–õ–ñ–ï–ù –≤–µ—Ä–Ω—É—Ç—å –ß–ò–°–¢–´–ô JSON-–æ–±—ä–µ–∫—Ç.

        –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
        1) –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        2) –ù–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–æ–¥—ã –û–ö–í–≠–î 2.
        3) –ü—Ä–∏–≤–µ—Å—Ç–∏ –∏—Ö –∫ —Ñ–æ—Ä–º–∞—Ç—É –∫–ª–∞—Å—Å.–ø–æ–¥–∫–ª–∞—Å—Å = XX.X:
           - 2 —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∞, 1 —Ü–∏—Ñ—Ä–∞.
           - –Ω–∞–ø—Ä–∏–º–µ—Ä: "47.1", "56.3", "62.0", "10.2".

        –û–°–û–ë–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –û–ë–©–ò–• –ó–ê–ü–†–û–°–û–í:

        - –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Å–ª–æ–≤–∞ "–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å", "–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å–µ–∫—Ç–æ—Ä",
          –∏ –ù–ï–¢ –¥—Ä—É–≥–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏,
          —Ç—ã –æ–±—è–∑–∞–Ω –≤–µ—Ä–Ω—É—Ç—å –®–ò–†–û–ö–ò–ô –Ω–∞–±–æ—Ä –∫–æ–¥–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏.
          –ü—Ä–∏–º–µ—Ä —Ç–∞–∫–æ–≥–æ –Ω–∞–±–æ—Ä–∞ (–º–æ–∂–µ—à—å –Ω–µ–º–Ω–æ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º):
          [
            "10.1",
            "14.1",
            "16.1",
            "16.2",
            "20.0",
            "24.0",
            "25.0",
            "29.0",
            "30.0"
          ]
          –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ù–ï–õ–¨–ó–Ø –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤.

        –û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:

        - –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç –¥–ª–∏–Ω–Ω—ã–π –∫–æ–¥ ("62.01", "56.10.1", "47.19.2") ‚Üí –ø—Ä–∏–≤–µ–¥–∏ –∫ —Ñ–æ—Ä–º–∞—Ç—É:
            "62.01" ‚Üí "62.0"
            "56.10.1" ‚Üí "56.1"
            "47.19.2" ‚Üí "47.1"
        - –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–æ–ø—É—Å—Ç–∏–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–æ–æ–±—â–µ –ù–ï –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
          (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ-—Ç–æ –ø—Ä–æ –ø–æ–≥–æ–¥—É, –ª–∏—á–Ω—É—é –∂–∏–∑–Ω—å –∏ —Ç.–ø.).

        –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
        "{user_message}"

        <REASONING>
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –≤–∏–¥—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –û–ö–í–≠–î.
        –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –æ–±—â–∏–º —Å–ª–æ–≤–æ–º –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä—É–ø–Ω—ã–π —Å–µ–∫—Ç–æ—Ä ("–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"),
        –≤–µ—Ä–Ω–∏ —à–∏—Ä–æ–∫–∏–π –Ω–∞–±–æ—Ä –∫–æ–¥–æ–≤, –∞ –Ω–µ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
        </REASONING>

        <ANSWER>
        {{
          "industries": []
        }}
        </ANSWER>
                """.strip()

        try:
            ans_raw = self.llm.chat(prompt_industries)
            logger.info(f"[filters][industries] raw_answer={ans_raw!r}")
            data = self._safe_json_loads(ans_raw) or {}
            industries_raw = data.get("industries", [])
        except Exception as e:
            logger.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å industries –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM: {e}")
            industries_raw = []

        # –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞: –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–∞—Ç—É XX.X
        industries: List[str] = []
        for code in industries_raw:
            if not isinstance(code, str):
                code = str(code)

            clean = "".join(ch for ch in code if ch.isdigit() or ch == ".")
            if not clean:
                continue

            parts = clean.split(".")

            # –≤–∞—Ä–∏–∞–Ω—Ç 1: —Ç–æ–ª—å–∫–æ –∫–ª–∞—Å—Å ‚Üí XX.0
            if len(parts) == 1 and parts[0].isdigit():
                industries.append(f"{parts[0]}.0")
                continue

            # –≤–∞—Ä–∏–∞–Ω—Ç 2: –∫–ª–∞—Å—Å.–ø–æ–¥–∫–ª–∞—Å—Å ‚Üí XX.X
            if len(parts) >= 2 and parts[0].isdigit() and parts[1].isdigit():
                industries.append(f"{parts[0]}.{parts[1][0]}")
                continue

        if industries:
            industries = list(set(industries))  # —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏
            state["filters"]["industries"] = industries
            logger.info(f"[filters] industries={industries}")

        # 2. –í—ã—Ä—É—á–∫–∞ (revenue)
        prompt_revenue = f"""
–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—É–º–∞–π –∏ –∑–∞–ø–∏—à–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <REASONING>...</REASONING>.
–ó–∞—Ç–µ–º –∑–∞–ø–∏—à–∏ –∏—Ç–æ–≥–æ–≤—ã–π JSON-–æ—Ç–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <ANSWER>...</ANSWER>.

<REASONING>
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

–ó–∞–¥–∞—á–∞: –ù–∞–π–¥–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≤—ã—Ä—É—á–∫–µ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏.

–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≤—ã—Ä—É—á–∫–∏:
- "–ú–µ–Ω–µ–µ 1 –º–ª–Ω.—Ä."
- "1-10 –º–ª–Ω.—Ä."
- "10-120 –º–ª–Ω.—Ä."
- "120-800 –º–ª–Ω.—Ä."
- "–ë–æ–ª–µ–µ 800 –º–ª–Ω.—Ä."

–ü—Ä–∏–º–µ—Ä—ã:
- "–≤—ã—Ä—É—á–∫–∞ 5 –º–ª–Ω" ‚Üí "1-10 –º–ª–Ω.—Ä."
- "–≤—ã—Ä—É—á–∫–∞ 50 –º–ª–Ω" ‚Üí "10-120 –º–ª–Ω.—Ä."
- "–æ–±–æ—Ä–æ—Ç 100-500 –º–ª–Ω" ‚Üí ["10-120 –º–ª–Ω.—Ä."]
- "–¥–æ—Ö–æ–¥ –º–µ–Ω–µ–µ 1 –º–ª–Ω" ‚Üí "–ú–µ–Ω–µ–µ 1 –º–ª–Ω.—Ä."
- "–±–æ–ª–µ–µ 1 –º–ª—Ä–¥" ‚Üí "–ë–æ–ª–µ–µ 800 –º–ª–Ω.—Ä."
</REASONING>

<ANSWER>
{{
  "revenue": []
}}
</ANSWER>
        """.strip()

        try:
            ans_raw = self.llm.chat(prompt_revenue)
            logger.info(f"[filters][revenue] raw_answer={ans_raw}")
            data = self._safe_json_loads(ans_raw) or {}
            revenue = data.get("revenue", [])
        except Exception as e:
            logger.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å revenue –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM: {e}")
            revenue = []

        if revenue:
            filters["revenue"] = revenue
            logger.info(f"[filters] revenue={revenue}")

        # 3. –®—Ç–∞—Ç (staff)
        # 3. –®—Ç–∞—Ç (staff)
        prompt_staff = f"""
    –¢—ã –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞.

    –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—É–º–∞–π –∏ –∑–∞–ø–∏—à–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <REASONING>...</REASONING>.
    –ó–∞—Ç–µ–º –∑–∞–ø–∏—à–∏ –∏—Ç–æ–≥–æ–≤—ã–π JSON-–æ—Ç–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <ANSWER>...</ANSWER>.

    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —à—Ç–∞—Ç–∞:
    - 1 —á–µ–ª–æ–≤–µ–∫ ‚Üí "1 —á–µ–ª."
    - 2-5 —á–µ–ª–æ–≤–µ–∫ ‚Üí "2-5 —á–µ–ª."
    - 6-30 —á–µ–ª–æ–≤–µ–∫ ‚Üí "6-30 —á–µ–ª."
    - 31-100 —á–µ–ª–æ–≤–µ–∫ ‚Üí "31-100 —á–µ–ª."
    - –±–æ–ª–µ–µ 100 —á–µ–ª–æ–≤–µ–∫ ‚Üí "–ë–æ–ª–µ–µ 100 —á–µ–ª."

    –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:
    - –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º "staff".
    - –ó–Ω–∞—á–µ–Ω–∏–µ "staff" ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.
    - –ü—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:
      {{
        "staff": ["–ë–æ–ª–µ–µ 100 —á–µ–ª."]
      }}
      –ª–∏–±–æ
      {{
        "staff": []
      }}
      –µ—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

    –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    "{user_message}"

    <REASONING>
    –ù–∞–π–¥–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ —à—Ç–∞—Ç–∞ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤—å –∏—Ö —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.
    </REASONING>

    <ANSWER>
    {{
      "staff": []
    }}
    </ANSWER>
            """.strip()

        try:
            ans_raw = self.llm.chat(prompt_staff)
            logger.info(f"[filters][staff] raw_answer={ans_raw!r}")
            data = self._safe_json_loads(ans_raw) or {}
            staff_raw = data.get("staff", [])
        except Exception as e:
            logger.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å staff –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM: {e}")
            staff_raw = []

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ —Å–ø–∏—Å–∫—É —Å—Ç—Ä–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        staff_categories: List[str] = []

        if isinstance(staff_raw, list):
            for item in staff_raw:
                if isinstance(item, str):
                    staff_categories.append(item.strip())
                elif isinstance(item, dict):
                    cat = item.get("category")
                    if isinstance(cat, str) and cat.strip():
                        staff_categories.append(cat.strip())

        staff_categories = list({c for c in staff_categories if c})

        if staff_categories:
            filters["staff"] = staff_categories
            logger.info(f"[filters] staff={staff_categories}")

            # 4. –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏ (tb) ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ LLM, –±–µ–∑ safe_json

        prompt_tb = f"""
    –¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–∏ (–¢–ë) –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞.

    –¢–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
    1) –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –≤ —Ç–µ–≥–∞—Ö <REASONING>...</REASONING>.
    2) –ü–æ—Ç–æ–º –ß–ò–°–¢–´–ô JSON –≤ —Ç–µ–≥–∞—Ö <ANSWER>...</ANSWER>, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

    –í–∞–∂–Ω–æ:
    - –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º "tb".
    - –ó–Ω–∞—á–µ–Ω–∏–µ "tb" ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ —Å –∫–æ–¥–∞–º–∏ –¢–ë.
    - –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∫–æ–¥—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.
    - –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ —è–≤–Ω–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è "–ú–æ—Å–∫–≤–∞" –∏–ª–∏ "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
      –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∏ –≤ –º–∞—Å—Å–∏–≤ –∫–æ–¥ "–ú–ë".
    - –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¢–ë ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤.

    –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¢–ë:
    - "–¶–ê", "–ë–ë", "–í–í–ë", "–î–í–ë", "–ú–ë", "–ü–ë",
      "–°–ó–ë", "–°–∏–±–ë", "–°–†–ë", "–£–ë", "–¶–ß–ë", "–Æ–ó–ë"

    –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    "{user_message}"

    <REASONING>
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, –∫ –∫–∞–∫–∏–º —Ä–µ–≥–∏–æ–Ω–∞–º –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è,
    –∑–∞—Ç–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤—å –∏—Ö —Å –∫–æ–¥–∞–º–∏ –¢–ë.
    </REASONING>

    <ANSWER>
    {{
      "tb": []
    }}
    </ANSWER>
            """.strip()

        try:
            ans_raw = self.llm.chat(prompt_tb)
            # ans_raw –∑–¥–µ—Å—å —É–∂–µ –î–û–õ–ñ–ï–ù –±—ã—Ç—å —Ç–æ–ª—å–∫–æ JSON –∏–∑ <ANSWER>, –±–µ–∑ REASONING
            logger.info(f"[filters][tb] ans_raw_for_parse={ans_raw!r}")
            data = self._safe_json_loads(ans_raw) or {}
            tb = data.get("tb", [])
        except Exception as e:
            logger.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å tb –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM: {e}")
            tb = []

        if tb:
            filters["tb"] = tb
            logger.info(f"[filters] tb={tb}")

        # 5. –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞ (product_type)
        prompt_product = f"""
–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—É–º–∞–π –∏ –∑–∞–ø–∏—à–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <REASONING>...</REASONING>.
–ó–∞—Ç–µ–º –∑–∞–ø–∏—à–∏ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <ANSWER>...</ANSWER>.

<REASONING>
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

–ó–∞–¥–∞—á–∞: –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞ - "–ö–æ—Ä–æ–±–∫–∞" –∏–ª–∏ "–ö–∞—Å—Ç–æ–º".

–ü—Ä–∞–≤–∏–ª–∞:
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: "–ö–æ—Ä–æ–±–∫–∞".
- –ò—Å–ø–æ–ª—å–∑—É–π "–ö–∞—Å—Ç–æ–º" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ: "–∫–∞—Å—Ç–æ–º", "–∫–∞—Å—Ç–æ–º–Ω—ã–π", "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π", "–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π".
</REASONING>

<ANSWER>
{{
  "product_type": "–ö–æ—Ä–æ–±–∫–∞"
}}
</ANSWER>
        """.strip()

        product_type = None
        try:
            ans_raw = self.llm.chat(prompt_product)
            logger.info(f"[filters][product_type] raw_answer={ans_raw}")
            data = self._safe_json_loads(ans_raw) or {}

            if isinstance(data, dict):
                product_type = data.get("product_type")
            else:
                # –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–¥—Ä—É–≥ –≤–µ—Ä–Ω—É–ª–∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É
                text_val = self._extract_answer_block(ans_raw).strip().strip('"').strip("'")
                if text_val in {"–ö–æ—Ä–æ–±–∫–∞", "–ö–∞—Å—Ç–æ–º"}:
                    product_type = text_val
        except Exception as e:
            logger.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å product_type –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM: {e}")
            product_type = None

        if product_type in {"–ö–æ—Ä–æ–±–∫–∞", "–ö–∞—Å—Ç–æ–º"}:
            state["product_type"] = product_type
            logger.info(f"[filters] product_type={product_type}")

        # 6. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞ (segment_params)
        prompt_params = f"""
–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞ –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—É–º–∞–π –∏ –∑–∞–ø–∏—à–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <REASONING>...</REASONING>.
–ó–∞—Ç–µ–º –∑–∞–ø–∏—à–∏ –∏—Ç–æ–≥–æ–≤—ã–π JSON-–æ—Ç–≤–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <ANSWER>...</ANSWER>.

–í–∞–∂–Ω–æ:
- –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ <ANSWER> –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –°–¢–†–û–ì–û –≤–∞–ª–∏–¥–Ω—ã–º JSON.
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω JSON-–æ–±—ä–µ–∫—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
- –í—Å–µ –∫–ª—é—á–∏ –∏ —Å—Ç—Ä–æ–∫–∏ –≤ –¥–≤–æ–π–Ω—ã—Ö –∫–∞–≤—ã—á–∫–∞—Ö.
- –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—è—Ç—ã—Ö –≤ –∫–æ–Ω—Ü–µ.

<REASONING>
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

–ó–∞–¥–∞—á–∞: –ù–∞–π–¥–∏ —á–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É–π –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ):
- mmb_dolya: –¥–æ–ª—è –≤–ª–∞–¥–µ–Ω–∏—è –¥–ª—è –ú–ú–ë (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 6.0)
- mmb_kpr: –ö–ø—Ä–∏–± –¥–ª—è –ú–ú–ë (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15.0)
- other_dolya: –¥–æ–ª—è –≤–ª–∞–¥–µ–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10.0)
- other_kpr: –ö–ø—Ä–∏–± –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20.0)
</REASONING>

<ANSWER>
{{
  "mmb_dolya": 6.0,
  "mmb_kpr": 15.0,
  "other_dolya": 10.0,
  "other_kpr": 20.0
}}
</ANSWER>
        """.strip()

        try:
            ans_raw = self.llm.chat(prompt_params)
            logger.info(f"[filters][segment_params] raw_answer={ans_raw}")
            data = self._safe_json_loads(ans_raw) or {}
        except Exception as e:
            logger.exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å segment_params –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM: {e}")
            data = {}

        if data:
            mmb_dolya = float(data.get("mmb_dolya", 6.0))
            mmb_kpr = float(data.get("mmb_kpr", 15.0))
            other_dolya = float(data.get("other_dolya", 10.0))
            other_kpr = float(data.get("other_kpr", 20.0))

            state["segment_params"] = {
                "–ú–ú–ë": {"dolya": mmb_dolya, "kpr": mmb_kpr},
                "–ö–°–ë": {"dolya": other_dolya, "kpr": other_kpr},
                "–°–ö–ú": {"dolya": other_dolya, "kpr": other_kpr},
                "–†–ì–°": {"dolya": other_dolya, "kpr": other_kpr},
                "KeyClients": {"dolya": other_dolya + 5.0, "kpr": other_kpr + 10.0},
            }
            logger.info(f"[filters] segment_params={state['segment_params']}")

        logger.info(f"[filters] –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ filters={state.get('filters')}")

    # ==== 3. –õ–æ–≥–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞ –∏ —Ä–∞—Å—á—ë—Ç–∞ =========================================

    def is_calculation_request(self, text: str) -> bool:
        text_low = text.lower()
        triggers = [
            "–ø–æ—Å—á–∏—Ç–∞–π",
            "–∑–∞–ø—É—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç",
            "—Å—á–∏—Ç–∞–π",
            "—Å—á–∏—Ç–∞—Ç—å",
            "—Ä–∞—Å—á—ë—Ç",
            "–∑–∞–ø—É—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç",
            "—Ä–∞—Å—Å—á–∏—Ç–∞–π",
            "–¥–∞–≤–∞–π —Å—á–∏—Ç–∞—Ç—å",
            "–º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å",
            "—Å–¥–µ–ª–∞–π —Ä–∞—Å—á–µ—Ç",
            "—Å–¥–µ–ª–∞–π —Ä–∞—Å—á—ë—Ç",
            "–Ω–∞—á–Ω–∏ —Ä–∞—Å—á–µ—Ç",
            "–Ω–∞—á–Ω–∏ —Ä–∞—Å—á—ë—Ç",
        ]
        return any(t in text_low for t in triggers)

    def build_agent_reply(self, state: Dict[str, Any], user_text: str) -> str:
        filters = state.get("filters", {})
        segment_params = state.get("segment_params", {})
        product_type = state.get("product_type", "–ö–æ—Ä–æ–±–∫–∞")

        system_context = f"""
–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ä–∞—Å—á—ë—Ç—É –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –ø—Ä–æ–¥–∞–∂.

–£ —Ç–µ–±—è –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- –û—Ç—Ä–∞—Å–ª–∏ (industries): {filters.get("industries")}
- –í—ã—Ä—É—á–∫–∞ (revenue): {filters.get("revenue")}
- –®—Ç–∞—Ç (staff): {filters.get("staff")}
- –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –±–∞–Ω–∫ (tb): {filters.get("tb")}
- –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞: {product_type}
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–¥–æ–ª—è, –ö–ø—Ä–∏–±): {json.dumps(segment_params, ensure_ascii=False)}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –£—Ç–æ—á–Ω—è—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞.
2. –ö—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫–æ–π —Å—Ä–µ–∑ —Ä—ã–Ω–∫–∞ —Å–µ–π—á–∞—Å –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è.
3. –û–±—ä—è—Å–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ –µ–≥–æ —É—Å—Ç—Ä–∞–∏–≤–∞—é—Ç —Ñ–∏–ª—å—Ç—Ä—ã, –æ–Ω –º–æ–∂–µ—Ç —Å–∫–∞–∑–∞—Ç—å "–∑–∞–ø—É—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç" –∏–ª–∏ "–ø–æ—Å—á–∏—Ç–∞–π".

–ì–æ–≤–æ—Ä–∏ –ø–æ-–¥–µ–ª–æ–≤–æ–º—É, –Ω–æ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –Ω–µ –±–æ–ª–µ–µ 3‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
–ü–æ—Å–ª–µ–¥–Ω—è—è —Ñ—Ä–∞–∑–∞ ‚Äî –≤—Å–µ–≥–¥–∞ —Å –±–µ–∑—É—Å–ª–æ–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º, —á—Ç–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –Ω—É–∂–Ω–æ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –æ–± —ç—Ç–æ–º.
        """.strip()

        prompt = f"""
{system_context}

–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—É–º–∞–π –∏ –∑–∞–ø–∏—à–∏ —Å–≤–æ–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <REASONING>...</REASONING>.
–ó–∞—Ç–µ–º –∑–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ <ANSWER>...</ANSWER>.

<REASONING>
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–ø–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ä–µ—à–∏, –Ω—É–∂–Ω–æ –ª–∏ —á—Ç–æ-—Ç–æ —É—Ç–æ—á–Ω–∏—Ç—å.
–†–µ–ø–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_text}"
</REASONING>

<ANSWER>
–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.
–ù–µ –±–æ–ª–µ–µ 3‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –ø–æ-—Ä—É—Å—Å–∫–∏.
–ü–æ—Å–ª–µ–¥–Ω–µ–π —Ñ—Ä–∞–∑–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏, —á—Ç–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –Ω—É–∂–Ω–æ —è–≤–Ω–æ —Å–∫–∞–∑–∞—Ç—å
—á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ "–∑–∞–ø—É—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç" –∏–ª–∏ "–ø–æ—Å—á–∏—Ç–∞–π".
</ANSWER>
        """.strip()

        ans_raw = self.llm.chat(prompt)
        answer = self._extract_answer_block(ans_raw)
        logger.info(f"[dialog] reply_answer={answer}")
        return answer

    def run_full_calculation(self, state: Dict[str, Any]) -> Dict[str, Any]:
        filters = state.get("filters", {}) or {}
        segment_params = state.get("segment_params", {}) or {}
        product_type = state.get("product_type", "–ö–æ—Ä–æ–±–∫–∞")

        logger.info(
            f"[calc] –ó–∞–ø—É—Å–∫ —Ä–∞—Å—á—ë—Ç–∞ —Å filters={filters}, "
            f"segment_params={segment_params}, product_type={product_type}"
        )

        result = calculate_potential_full_pipeline(
            data_directory=self.data_dir,
            filters=filters,
            segment_params=segment_params,
            product_type=product_type,
        )
        return result

    def summarize_result_for_user(self, result: Dict[str, Any], top_n_per_segment: int = 10) -> str:
        """
        –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ–∑—é–º–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–ï–ó —Ç–∞–±–ª–∏—Ü.

        –ü–æ–∫–∞–∑—ã–≤–∞–µ–º:
        - –æ–±—â–∏–π –∏—Ç–æ–≥;
        - —Å—É–º–º–∞—Ä–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º (–≤—Å–µ–≥–æ –∏ —Ç–æ–ª—å–∫–æ "–¥–∞");
        - –ø–æ –∫–∞–∂–¥–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É: —Ç–æ–ø-N –∫–∞–Ω–∞–ª–æ–≤ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–≤ –≤–∏–¥–µ –º–∞—Ä–∫–µ—Ä–æ–≤).
        """
        rows: List[Dict[str, Any]] = result.get("potential_results", [])
        segment_metrics = result.get("segment_metrics", {})
        filtered_count = result.get("filtered_records_count", 0)

        # --- –æ–±—â–∏–π –∏—Ç–æ–≥ –ø–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º ---
        total_potential_all = sum(float(r.get("total_potential", 0.0)) for r in rows)
        ok_rows = [r for r in rows if str(r.get("–†–µ—à–µ–Ω–∏–µ", "")).lower() == "–¥–∞"]

        lines: List[str] = []
        lines.append(f"‚úî –†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –í –≤—ã–±–æ—Ä–∫—É –ø–æ–ø–∞–ª–æ {filtered_count} –∑–∞–ø–∏—Å–µ–π.")
        lines.append(f"‚úî –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(segment_metrics)} —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –≤—ã–ø–æ–ª–Ω–µ–Ω —Ä–∞—Å—á—ë—Ç.")
        lines.append(f"‚úî –ò—Ç–æ–≥–æ–≤—ã–π —Å—É–º–º–∞—Ä–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º: ~{round(total_potential_all, 3)} –º–ª–Ω —Ä—É–±.")
        lines.append(f"‚úî –ö–∞–Ω–∞–ª–æ–≤ —Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º (\"–¥–∞\"): {len(ok_rows)}.")

        # --- –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º ---
        seg_total: Dict[str, float] = {}
        seg_total_ok: Dict[str, float] = {}

        for r in rows:
            seg = r.get("–°–µ–≥–º–µ–Ω—Ç", "N/A")
            pot = float(r.get("total_potential", 0.0))
            seg_total[seg] = seg_total.get(seg, 0.0) + pot
            if str(r.get("–†–µ—à–µ–Ω–∏–µ", "")).lower() == "–¥–∞":
                seg_total_ok[seg] = seg_total_ok.get(seg, 0.0) + pot

        if seg_total:
            lines.append("\nüìä –°—É–º–º–∞—Ä–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º:")
            for seg, pot in sorted(seg_total.items(), key=lambda x: x[1], reverse=True):
                ok_pot = seg_total_ok.get(seg, 0.0)
                lines.append(
                    f"  ‚Ä¢ {seg}: –≤—Å–µ–≥–æ ~{round(pot, 3)} –º–ª–Ω —Ä—É–±., "
                    f"–∏–∑ –Ω–∏—Ö –ø–æ \"–¥–∞\" ~{round(ok_pot, 3)} –º–ª–Ω —Ä—É–±."
                )

        # --- –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞–Ω–∞–ª–∞–º –≤–Ω—É—Ç—Ä–∏ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ ---
        seg_rows: Dict[str, List[Dict[str, Any]]] = {}
        for r in rows:
            seg = r.get("–°–µ–≥–º–µ–Ω—Ç", "N/A")
            seg_rows.setdefault(seg, []).append(r)

        lines.append("\nüìå –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞–Ω–∞–ª–∞–º –≤–Ω—É—Ç—Ä–∏ —Å–µ–≥–º–µ–Ω—Ç–æ–≤:")

        for seg, seg_list in sorted(seg_rows.items(), key=lambda kv: seg_total.get(kv[0], 0.0), reverse=True):
            lines.append(f"\n‚ñ∂ –°–µ–≥–º–µ–Ω—Ç: {seg}")

            # —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–Ω–∞–ª—ã –≤–Ω—É—Ç—Ä–∏ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—É
            seg_list_sorted = sorted(
                seg_list,
                key=lambda r: float(r.get("total_potential", 0.0)),
                reverse=True,
            )

            limited = seg_list_sorted[:top_n_per_segment]

            for r in limited:
                ch = str(r.get("–ö–∞–Ω–∞–ª", "N/A"))
                pot = float(r.get("total_potential", 0.0))
                calc_clients = r.get("calc_clients", "")
                rate_ab = r.get("rate_ab", "")
                decision = r.get("–†–µ—à–µ–Ω–∏–µ", "")

                # –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª, –±–µ–∑ —Ç–∞–±–ª–∏—Ü
                lines.append(
                    f"  ‚Ä¢ –ö–∞–Ω–∞–ª: {ch}; –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª ~{round(pot, 3)} –º–ª–Ω —Ä—É–±.; "
                    f"–∫–ª–∏–µ–Ω—Ç–æ–≤ ‚âà {calc_clients}; —Å—Ç–∞–≤–∫–∞ {rate_ab}%; —Ä–µ—à–µ–Ω–∏–µ: {decision}"
                )

            if len(seg_list_sorted) > len(limited):
                lines.append(f"  ‚Ä¢ ‚Ä¶ –µ—â—ë {len(seg_list_sorted) - len(limited)} –∫–∞–Ω–∞–ª(–æ–≤) –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ –æ–ø—É—â–µ–Ω–æ.")

        lines.append(
            "\n–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª—ã —Å —Ä–µ—à–µ–Ω–∏–µ–º \"–¥–∞\", "
            "–∏–ª–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ú–ú–ë\")."
        )

        return "\n".join(lines)


